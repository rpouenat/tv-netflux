


# https://api-mobile.yatta.francetv.fr/apps/directs/france-3?platform=apps
# User-Agent: yatta/161 CFNetwork/1492.0.1 Darwin/23.3.0

# On récupère alors si_id


# https://k7.ftven.fr/videos/29bdf749-7082-4426-a4f3-595cc436aa0d?country_code=FR&player_version=6.2.2&os=iOS
# User-Agent: yatta/161 CFNetwork/1492.0.1 Darwin/23.3.0

# Réponse 

# {"video":{"workflow":"dai","token":"https://hdfauth.ftven.fr/esi/TA?format=json","duration":null,"embed":false,"format":"hls","is_live":true,"drm":false,"drm_type":null,"license_type":null,"spritesheets":[],"is_startover_enabled":false,"previously":{"timecode":null,"duration":null,"time_before_dismiss":null},"coming_next":{"duration":null,"time_before_dismiss":null,"timecode":null},"skip_intro":{"timecode":null,"duration":null,"time_before_dismiss":null},"closing_credits":{"timecode":null},"timeshiftable":"auto","dai_type":"adswitching","url":"https://live-ssai.ftven.fr/dai/v1/master/14bff07f70f2518f32f1c6cc13a91ef489dc83f1/SSARFrance3OTTEMTConfiguration/out/v1/0790ec6bf91946e1b6c9f5e3ff367db6/index.m3u8","offline":null,"is_highlightable":true},"meta":{"id":"29bdf749-7082-4426-a4f3-595cc436aa0d","title":"France 3 en direct","additional_title":null,"pre_title":null,"broadcasted_at":null,"image_url":null},"markers":{"estat":{"crmID":null,"dom":"APP_VERSION=10.30.2/PLAYER_VERSION=6.2.2/PACKAGE_NAME=fr.francetv.apps.pluzz","level1":"france3","level2":"france3endirect","level3":"indetermine","level4":"direct","level5":null,"serial":"285085208120","streamGenre":"app iPhone","streamName":"France 3 en direct-10/03/2024-SIM_france3","streamDuration":null,"newLevel1":"direct","newLevel2":"29bdf749-7082-4426-a4f3-595cc436aa0d","newLevel3":"timeshiftable_auto","newLevel4":"S00_E00","newLevel5":"-","newLevel6":"online","newLevel7":"tunnel_france3endirect","newLevel8":null,"newLevel9":null,"newLevel10":"iphone13,4","newLevel12":null,"newLevel13":null,"newLevel14":null,"newLevel15":null,"mediaContentId":"SIM_france3","mediaDiffMode":"LIVE","mediaChannel":"3","netMeasurement":null},"npaw":{"title":"France 3 en direct","title_episode":null,"program":"france3endirect","season":null,"content_id":"29bdf749-7082-4426-a4f3-595cc436aa0d","drm_type":null,"channel":"france3","content_type":"timeshifting_auto","content_genre":"indetermine","app_version":"10.30.2","customDimension1":"france.tv","customDimension2":"ios","customDimension3":"29bdf749-7082-4426-a4f3-595cc436aa0d?country_code=FR&diffusion_mode=tunnel_first&connection_type=WiFi&player_version=6.2.2&os=iOS&os_version=17.3.1&device=iPhone13,4&device_type=mobile&package_name=fr.francetv.apps.pluzz&app_version=10.30.2","customDimension4":null,"customDimension5":null,"customDimension6":null,"customDimension7":"wifi","customDimension8":"live","customDimension9":"live_without_zapping"},"analytics":{"isTrackingEnabled":true,"idSite":578440,"variant":"[timeshiftable_auto]","generalPlacement":"[france3]","detailedPlacement":"","url":"[france_3_en_direct]","server":"https://logs1238.xiti.com/hit.xiti","diffusionDate":null,"programName":"france_3_en_direct","videoTitle":"france_3_en_direct","videoProductId":null,"videoFactoryId":"29bdf749-7082-4426-a4f3-595cc436aa0d","season":null,"videoType":"direct","videoCategory":"indetermine","videoSubCategory":null},"pub":{"csid":"www.iphonefrancetv.fr","caid":"29bdf749-7082-4426-a4f3-595cc436aa0d","afid":"137378050","sfid":"6963749","capping":300,"midroll_timecode":[],"isPreview6h":false,"isPreview":false,"mediaTailorUrl":"https://api.ssai.ftven.fr/v1/session/14bff07f70f2518f32f1c6cc13a91ef489dc83f1/SSARFrance3OTTEMTConfiguration/out/v1/0790ec6bf91946e1b6c9f5e3ff367db6/index.m3u8","pollingInterval":8000,"profile":"511351:ftv_html5","pauseroll":{"enabled":false,"delay":6,"cappingPreroll":0,"cappingPauseroll":120}},"piano":{"isTrackingEnabled":true,"siteId":634565,"contentStatus":"direct","channel":"france3","program":"france_3_en_direct","server":"logs1238.xiti.com","contentDiffusionDate":"","contentTitle":"france_3_en_direct","contentType":"timeshiftable_auto","contentId":null,"videoFactoryId":"29bdf749-7082-4426-a4f3-595cc436aa0d","season":null,"category":"indetermine","subCategory":null,"originServer":"ftv-aws-mediapackage","broadcastingType":"video","daiStatus":true}}}
# User-Agent: yatta/161 CFNetwork/1492.0.1 Darwin/23.3.0


# https://hdfauth.ftven.fr/esi/TA?format=json&url=https://live-ssai.ftven.fr/dai/v1/master/14bff07f70f2518f32f1c6cc13a91ef489dc83f1/SSARFrance3OTTEMTConfiguration/out/v1/0790ec6bf91946e1b6c9f5e3ff367db6/index.m3u8?aws.sessionId%3Dac4fa634-6265-4cb8-a701-2bfc179c1d85

# Renvoie 

# {"url": "https://live-ssai.ftven.fr/ZXhwPTE3MTAxMTgxMzZ+YWNsPSUyZip+aG1hYz03NWViY2ZiN2JjMGE0ZWRkN2UxNTcyYThlYjI2OTMyOWNkOWE1YTIyYjc4N2RmZmZmYjgyOTA2YWU5YzQ1NjM1/dai/v1/master/14bff07f70f2518f32f1c6cc13a91ef489dc83f1/SSARFrance3OTTEMTConfiguration/out/v1/0790ec6bf91946e1b6c9f5e3ff367db6/index.m3u8?aws.sessionId=ac4fa634-6265-4cb8-a701-2bfc179c1d85&hdnea=exp=1710097136~acl=%2f*~hmac=8f6ace3990e10a384be8ca7706d2ece01bbf72befb4cf98c987c4587528b25ba"}

import requests
from flask import render_template, request, jsonify
from ..functions.functions import json_return, facebookNotification
from flask import current_app
import time

from seleniumwire import webdriver
from seleniumwire.utils import decode as sw_decode
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.common.exceptions import TimeoutException
import json
import time


# # Permet de récupérer tous les commentaires pour un media
# def getUrlFranceTV(chaine_name):

# 	# Possibilité de chaine 
# 	# france-2
# 	# france-3
# 	# france-4
# 	# france-5
# 	# franceinfo

# 	error = ""
# 	data_output = {}
# 	data_output["url"] = ""
# 	# On set le type de vidéo récupéré
# 	data_output["type"] = "application/x-mpegURL"

# 	# Si on a choisi la bonne chaine
# 	if chaine_name in [ "france-2", "france-3", "france-4", "france-5", "franceinfo" ]:

# 		headers = { "User-Agent": "yatta/161 CFNetwork/1492.0.1 Darwin/23.3.0" }
# 		req = requests.get("https://api-mobile.yatta.francetv.fr/apps/directs/" + chaine_name + "?platform=apps", headers=headers)
# 		# Si on a un bon code retour
# 		if req.status_code == 200:
# 			# On récupère le si_id du live
# 			si_id = req.json()["item"]["channel"]["si_id"]
# 			url_k7 = "https://k7.ftven.fr/videos/" + si_id + "?country_code=FR&player_version=6.2.2&os=iOS"
# 			req = requests.get(url_k7, headers=headers)
# 			if req.status_code == 200:
# 				video_url = req.json()["video"]["url"]
# 				req = requests.get("https://hdfauth.ftven.fr/esi/TA?format=json&url=" + video_url, headers=headers)
# 				# print(video_url)
# 				if req.status_code == 200:
# 					url = req.json()["url"]

# 					# data_output["url"] = url
# 					# Si on est en production
# 					if current_app.config.get('env') == "production":
# 						if "live-ssai.ftven.fr" in url:
# 							data_output["url"] = url.replace("https://live-ssai.ftven.fr/", "https://netflux.fun:2083/tv/francetv/live-ssai/")
# 						elif "simulcast-p.ftven.fr" in url:
# 							data_output["url"] = url
# 							# data_output["url"] = url.replace("https://simulcast-p.ftven.fr/", "https://netflux.fun:2083/tv/francetv/simulcast-p/")
# 					else:
# 						if "live-ssai.ftven.fr" in url:
# 							data_output["url"] = url.replace("https://live-ssai.ftven.fr/", "https://netflux.fun:2087/tv/francetv/live-ssai/")
# 						elif "simulcast-p.ftven.fr" in url:
# 							data_output["url"] = url
# 							# data_output["url"] = url.replace("https://simulcast-p.ftven.fr/", "https://netflux.fun:2087/tv/francetv/simulcast-p/")

# 					# # On vérifie qu'on a bien netflux.fun dans l'url
# 					# if "netflux.fun" not in data_output["url"]:
# 					# 	data_output["url"] = ""
# 					# 	error = "Bad Link"
# 					# 	# On envoie un message facebook
# 					# 	message = "BUG Application TV : \n\n"
# 					# 	message += "Impossibilité de mettre netflux.fun dans le lien : \n\n"
# 					# 	message += "\t- " + json_data["url"]
# 					# 	facebookNotification(message)
# 	else:
# 		error = "Unknown TV"

# 	return error, data_output











# Permet de récupérer tous les commentaires pour un media
def getUrlFranceTV(chaine_name):

	# Possibilité de chaine 
	# france-2
	# france-3
	# france-4
	# france-5
	# franceinfo

	user_francetv = "georgesdupont2128@protonmail.com"
	password_francetv = "YS;=MYiUL:2wmL7"

	error = ""
	data_output = {}
	data_output["url"] = ""
	# On set le type de vidéo récupéré
	data_output["type"] = "application/x-mpegURL"

	# Si on a choisi la bonne chaine
	if chaine_name in [ "france-2", "france-3", "france-4", "france-5", "franceinfo" ]:

		chrome_options = webdriver.ChromeOptions()
		chrome_options.add_argument('--headless')
		chrome_options.add_argument('--disable-dev-shm-usage')
		chrome_options.add_argument('--no-sandbox')
		chrome_options.add_argument('--window-size=1920,1080')

		# svc    = webdriver.ChromeService(executable_path="/usr/bin/chromium")
		driver = webdriver.Chrome(options=chrome_options)

		driver.get('https://www.france.tv/connexion/')
		# driver.save_screenshot('connexion_page.png')

		# On rentre identifiant et mot de passe
		email = driver.find_element(By.ID, "login_email")
		email.send_keys(user_francetv)

		password = driver.find_element(By.ID, "login_password")
		password.send_keys(password_francetv)

		# On appuie sur se connecter
		button_connect = driver.find_element(By.ID, "login_validate")
		button_connect.click()

		time.sleep(1)

		# driver.save_screenshot('connected.png')


		# On va sur la page de la TV
		# driver.get('https://www.france.tv/france-2/direct.html')
		driver.get('https://www.france.tv/'+chaine_name+'/direct.html')

		test_addblock = False
		try:
			# On attends que la page ait chargée
			elem = WebDriverWait(driver, 4).until(
				EC.presence_of_element_located((By.CLASS_NAME, "js-hide-adblock")) #This is a dummy element
			)
			test_addblock = True
		except TimeoutException:
			pass

		if test_addblock:
			# On désactive le bouton js-hide-adblock
			button_bypassadblock = driver.find_element(By.CLASS_NAME, "js-hide-adblock")
			button_bypassadblock.click()


		max_try = 10
		i = 0
		url_find = False

		# Tant qu'on a pas l'url on attends
		while (not url_find) and (i < max_try):

			# driver.save_screenshot('direct.png')

			# On parcourt les requêtes du navigateur
			for req in driver.requests:
				# print("[+] URL : " + req.url)
				if ("esi/TA".lower() in req.url.lower()) and ("format=json" in req.url.lower()):
					print("[+] URL : " + req.url)
					data = sw_decode(req.response.body, req.response.headers.get('Content-Encoding', 'identity'))
					json_data = json.loads(data.decode("utf8"))

					# Si on est en production
					# if current_app.config.get('env') == "production":
					# 	data_output["url"] = json_data["url"].replace("https://live-ssai.ftven.fr/", "https://netflux.fun:2083/tv/francetv/live-ssai/")
					# else:
					# 	data_output["url"] = json_data["url"].replace("https://live-ssai.ftven.fr/", "https://netflux.fun:2087/tv/francetv/live-ssai/")

					if current_app.config.get('env') == "production":
						if "live-ssai.ftven.fr" in url:
							data_output["url"] = json_data["url"].replace("https://live-ssai.ftven.fr/", "https://netflux.fun:2083/tv/francetv/live-ssai/")
						elif "simulcast-p.ftven.fr" in url:
							data_output["url"] = url
							# data_output["url"] = json_data["url"].replace("https://simulcast-p.ftven.fr/", "https://netflux.fun:2083/tv/francetv/simulcast-p/")
					else:
						if "live-ssai.ftven.fr" in url:
							data_output["url"] = json_data["url"].replace("https://live-ssai.ftven.fr/", "https://netflux.fun:2087/tv/francetv/live-ssai/")
						elif "simulcast-p.ftven.fr" in url:
							# data_output["url"] = url
							data_output["url"] = json_data["url"].replace("https://simulcast-p.ftven.fr/", "https://netflux.fun:2087/tv/francetv/simulcast-p/")



					url_find = True
					# On vérifie qu'on a bien netflux.fun dans l'url
					if "netflux.fun" not in data_output["url"]:
						data_output["url"] = ""
						error = "Bad Link"
						# On envoie un message facebook
						message = "BUG Application TV : \n\n"
						message += "Impossibilité de mettre netflux.fun dans le lien : \n\n"
						message += "\t- " + json_data["url"]
						facebookNotification(message)
			i += 1
			time.sleep(1)

		# On ferme le driver
		driver.quit()

	else:
		error = "Unknown TV"

	return error, data_output







