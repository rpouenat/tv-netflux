from .. import api
import time
from flask import render_template, request, jsonify
from flask import Response
import base64
import requests


# Permet de récupérer tous les commentaires pour un media
@api.route('/license', methods=['OPTIONS'])
def getOptionsLicense():

	# Date: Wed, 13 Mar 2024 16:54:03 GMT
	# Content-Length: 0
	# Connection: close
	# X-AxDRM-Identity: Axinom DRM - Widevine API
	# X-AxDRM-Version: 6.24.1
	# X-AxDRM-Server: widevine-testing-68f88bb687-57q4v
	# Access-Control-Allow-Origin: *
	# Access-Control-Expose-Headers: X-AxDrm-ErrorMessage,X-AxDRM-Message,X-AxDRM-Identity,X-AxDRM-Server,X-AxDRM-Version,X-Powered-By,WWW-Authenticate
	# Access-Control-Allow-Headers: Content-Type, X-AxDRM-Message
	# Access-Control-Allow-Methods: POST
	# Access-Control-Max-Age: 86400
	# Strict-Transport-Security: max-age=15724800; includeSubDomains
	resp = Response("")
	resp.headers['X-AxDRM-Identity'] = 'Axinom DRM - Widevine API'
	resp.headers['X-AxDRM-Version']= '6.24.1'
	resp.headers['Access-Control-Allow-Origin']= '*'
	resp.headers['Access-Control-Expose-Headers']= 'X-AxDrm-ErrorMessage,X-AxDRM-Message,X-AxDRM-Identity,X-AxDRM-Server,X-AxDRM-Version,X-Powered-By,WWW-Authenticate'
	resp.headers['Access-Control-Allow-Headers']= 'Content-Type, X-AxDRM-Message'
	resp.headers['Access-Control-Allow-Methods']= 'POST'
	resp.headers['Access-Control-Max-Age']= '86400'
	resp.headers['Strict-Transport-Security']= 'max-age=15724800; includeSubDomains'
	return resp

# Permet de récupérer tous les commentaires pour un media
@api.route('/license', methods=['POST'])
def getPOSTLICENCE():

	headers = {
		"X-AxDRM-Message" : "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ2ZXJzaW9uIjoxLCJjb21fa2V5X2lkIjoiYjMzNjRlYjUtNTFmNi00YWUzLThjOTgtMzNjZWQ1ZTMxYzc4IiwibWVzc2FnZSI6eyJ0eXBlIjoiZW50aXRsZW1lbnRfbWVzc2FnZSIsImtleXMiOlt7ImlkIjoiOWViNDA1MGQtZTQ0Yi00ODAyLTkzMmUtMjdkNzUwODNlMjY2IiwiZW5jcnlwdGVkX2tleSI6ImxLM09qSExZVzI0Y3Iya3RSNzRmbnc9PSJ9XX19.4lWwW46k-oWcah8oN18LPj5OLS5ZU-_AQv7fe0JhNjA"
	}


	input_data = request.get_data(parse_form_data=True)

	license = ""

	if input_data == bytes(b'\x08\x04'):
		# First
		# req = requests.post("https://drm-widevine-licensing.axtest.net/AcquireLicense", data=input_data)
		# license = req.content
		# license = "CAUSvQUKtwIIAxIQYeVhKzEgUzSQRG+gBa2tehiKv8bKBSKOAjCCAQoCggEBAKUminOPh0+qlNDB/ixbttfsHZgPcphLRuXCwWjtocB+dC8ZXlXC8+Sjf33ztrNV474M8DDnGW4/MhpKKldmun+4tChO+6OPprhWQ3pAQwXuWuZ9V8+3LsefGpAs0vEReQDvfGweXwGbHvHBqNVJdOS78w41N5/omSCdZGGy1dtZ3Vq30EzCK2J8qEb7eXxwVo1Xe7ff7UMO+HkWIKqzCWpUKCotMZY/CIDhszfhyGrkWKn3HG18LgfewgrUVXKdW4V0OfZmaX4qZk/KLTK5cx9Vz1UDTmoZmyYaIrAwXG5QukRU8aqUrPXNilNTZCExNUbTzi8rAptTvqHMPB33sa0CAwEAAToKYXhpbm9tLmNvbRKAAzCG6ogvjaVctNchprNdGgmCcvmIBM/BTL4Giy3rXuLHWj2DGeqlMlsKwsrceKbkdBFARIaZNZ6d6GgPrit6oIkbbPma27yXMnRex9AWgV3qWMYvEtCR13ieMzgciJOFd29zJZwBFilPHJeD9hXLxJpYHxjGDBCivlENSQvtdUItytu8K6zfY4RhjqoAHJ1LSOxDwjwOhNOaU/rY01+ICtevXAAxN6K9FnPjfXsKxhbAWl2DtN1B+kvSnogsWaHhObHi7jFoWcbVHqoM1wAyWfWJvWQjo/Q32WHpzZzSYxhUG/pi5p5vsqvzCPG51wbTelnkN88ZWkpMHC5KKBrfTzSC29vmEHW7jA4jgLqQY3QC8zgm8K4anIEHFYsgzSo9JamaZCxorHNau4QtR20/PpbDN8V/9CSV3nvuV/IXBd0essaR8xxGNbVIQvC00Tg6+Cs9QoyieLzZuytaXBPT+7D9drfA6Gv7KZWtO4Se6q8csrzBqaQtKYU+cobFOVmYiw=="
		license = bytes(b'\x08\x05\x12\xbd\x05\x0a\xb7\x02\x08\x03\x12\x10\x61\xe5\x61\x2b\x31\x20\x53\x34\x90\x44\x6f\xa0\x05\xad\xad\x7a\x18\x8a\xbf\xc6\xca\x05\x22\x8e\x02\x30\x82\x01\x0a\x02\x82\x01\x01\x00\xa5\x26\x8a\x73\x8f\x87\x4f\xaa\x94\xd0\xc1\xfe\x2c\x5b\xb6\xd7\xec\x1d\x98\x0f\x72\x98\x4b\x46\xe5\xc2\xc1\x68\xed\xa1\xc0\x7e\x74\x2f\x19\x5e\x55\xc2\xf3\xe4\xa3\x7f\x7d\xf3\xb6\xb3\x55\xe3\xbe\x0c\xf0\x30\xe7\x19\x6e\x3f\x32\x1a\x4a\x2a\x57\x66\xba\x7f\xb8\xb4\x28\x4e\xfb\xa3\x8f\xa6\xb8\x56\x43\x7a\x40\x43\x05\xee\x5a\xe6\x7d\x57\xcf\xb7\x2e\xc7\x9f\x1a\x90\x2c\xd2\xf1\x11\x79\x00\xef\x7c\x6c\x1e\x5f\x01\x9b\x1e\xf1\xc1\xa8\xd5\x49\x74\xe4\xbb\xf3\x0e\x35\x37\x9f\xe8\x99\x20\x9d\x64\x61\xb2\xd5\xdb\x59\xdd\x5a\xb7\xd0\x4c\xc2\x2b\x62\x7c\xa8\x46\xfb\x79\x7c\x70\x56\x8d\x57\x7b\xb7\xdf\xed\x43\x0e\xf8\x79\x16\x20\xaa\xb3\x09\x6a\x54\x28\x2a\x2d\x31\x96\x3f\x08\x80\xe1\xb3\x37\xe1\xc8\x6a\xe4\x58\xa9\xf7\x1c\x6d\x7c\x2e\x07\xde\xc2\x0a\xd4\x55\x72\x9d\x5b\x85\x74\x39\xf6\x66\x69\x7e\x2a\x66\x4f\xca\x2d\x32\xb9\x73\x1f\x55\xcf\x55\x03\x4e\x6a\x19\x9b\x26\x1a\x22\xb0\x30\x5c\x6e\x50\xba\x44\x54\xf1\xaa\x94\xac\xf5\xcd\x8a\x53\x53\x64\x21\x31\x35\x46\xd3\xce\x2f\x2b\x02\x9b\x53\xbe\xa1\xcc\x3c\x1d\xf7\xb1\xad\x02\x03\x01\x00\x01\x3a\x0a\x61\x78\x69\x6e\x6f\x6d\x2e\x63\x6f\x6d\x12\x80\x03\x30\x86\xea\x88\x2f\x8d\xa5\x5c\xb4\xd7\x21\xa6\xb3\x5d\x1a\x09\x82\x72\xf9\x88\x04\xcf\xc1\x4c\xbe\x06\x8b\x2d\xeb\x5e\xe2\xc7\x5a\x3d\x83\x19\xea\xa5\x32\x5b\x0a\xc2\xca\xdc\x78\xa6\xe4\x74\x11\x40\x44\x86\x99\x35\x9e\x9d\xe8\x68\x0f\xae\x2b\x7a\xa0\x89\x1b\x6c\xf9\x9a\xdb\xbc\x97\x32\x74\x5e\xc7\xd0\x16\x81\x5d\xea\x58\xc6\x2f\x12\xd0\x91\xd7\x78\x9e\x33\x38\x1c\x88\x93\x85\x77\x6f\x73\x25\x9c\x01\x16\x29\x4f\x1c\x97\x83\xf6\x15\xcb\xc4\x9a\x58\x1f\x18\xc6\x0c\x10\xa2\xbe\x51\x0d\x49\x0b\xed\x75\x42\x2d\xca\xdb\xbc\x2b\xac\xdf\x63\x84\x61\x8e\xaa\x00\x1c\x9d\x4b\x48\xec\x43\xc2\x3c\x0e\x84\xd3\x9a\x53\xfa\xd8\xd3\x5f\x88\x0a\xd7\xaf\x5c\x00\x31\x37\xa2\xbd\x16\x73\xe3\x7d\x7b\x0a\xc6\x16\xc0\x5a\x5d\x83\xb4\xdd\x41\xfa\x4b\xd2\x9e\x88\x2c\x59\xa1\xe1\x39\xb1\xe2\xee\x31\x68\x59\xc6\xd5\x1e\xaa\x0c\xd7\x00\x32\x59\xf5\x89\xbd\x64\x23\xa3\xf4\x37\xd9\x61\xe9\xcd\x9c\xd2\x63\x18\x54\x1b\xfa\x62\xe6\x9e\x6f\xb2\xab\xf3\x08\xf1\xb9\xd7\x06\xd3\x7a\x59\xe4\x37\xcf\x19\x5a\x4a\x4c\x1c\x2e\x4a\x28\x1a\xdf\x4f\x34\x82\xdb\xdb\xe6\x10\x75\xbb\x8c\x0e\x23\x80\xba\x90\x63\x74\x02\xf3\x38\x26\xf0\xae\x1a\x9c\x81\x07\x15\x8b\x20\xcd\x2a\x3d\x25\xa9\x9a\x64\x2c\x68\xac\x73\x5a\xbb\x84\x2d\x47\x6d\x3f\x3e\x96\xc3\x37\xc5\x7f\xf4\x24\x95\xde\x7b\xee\x57\xf2\x17\x05\xdd\x1e\xb2\xc6\x91\xf3\x1c\x46\x35\xb5\x48\x42\xf0\xb4\xd1\x38\x3a\xf8\x2b\x3d\x42\x8c\xa2\x78\xbc\xd9\xbb\x2b\x5a\x5c\x13\xd3\xfb\xb0\xfd\x76\xb7\xc0\xe8\x6b\xfb\x29\x95\xad\x3b\x84\x9e\xea\xaf\x1c\xb2\xbc\xc1\xa9\xa4\x2d\x29\x85\x3e\x72\x86\xc5\x39\x59\x98\x8b')
	else:

		# print(len(input_data))
		# First
		req = requests.post("https://drm-widevine-licensing.axtest.net/AcquireLicense", data=input_data, headers=headers)
		print(req.content)
		license = req.content

		# # Second
		# license = bytes(b'\x08\x02\x12\xee\x01\x0a\x2a\x0a\x10\x07\x86\x94\xb2\xe9\xe4\xa2\x5a\xb4\x7c\xae\x14\x1e\xbd\x35\x17\x12\x08\xbb\x36\x4a\x13\x4a\xe8\x64\x97\x20\x01\x28\x00\x38\x00\x40\x00\x48\x9d\xc0\xc8\xaf\x06\x12\x10\x08\x01\x10\x00\x18\x00\x20\x00\x28\x00\x60\x01\x70\x00\x78\x00\x1a\x56\x12\x10\xc7\xe6\x4b\xa7\xb7\x08\xe5\x41\x33\xe6\x70\xbf\xfa\x12\x0b\x21\x1a\x40\x93\x63\xaa\x5e\xba\x7b\x08\xd2\xc4\xdb\x82\x0e\x3a\xd8\x0d\xd7\xbf\x90\x3f\x1e\x2d\x79\x08\x57\xd4\xfb\xe9\xb8\xe9\x4c\x92\xb9\xc6\x45\xfa\x44\xeb\xfc\x41\xa6\xd8\xa5\x04\xfc\xf4\xe1\x53\xb0\xd9\x35\x6a\x87\x72\xe1\x9b\xf5\xfe\x8c\x65\x30\xc3\x5e\xb2\x0d\x20\x01\x1a\x4c\x0a\x10\x9e\xb4\x05\x0d\xe4\x4b\x48\x02\x93\x2e\x27\xd7\x50\x83\xe2\x66\x12\x10\x42\xf1\xeb\x74\xba\x27\x6d\x36\x81\xe5\x26\x16\xa0\x9a\x86\xac\x1a\x10\x07\x18\x9b\x7c\x77\x84\x2f\xf0\x80\xa8\x4e\x52\x56\xc7\xf7\x4d\x20\x02\x42\x12\x0a\x10\x6b\x63\x31\x36\x00\x00\x00\x00\x87\xee\x91\xc0\x00\x00\x00\x08\x20\x9d\xc0\xc8\xaf\x06\x38\x00\x50\x02\x1a\x20\x9e\x64\xee\x1a\x6e\x7e\x16\x4e\xe0\x40\x4a\x8a\x9e\x93\x33\x9c\x1c\x4f\xcf\x0a\x62\x87\x2b\x48\x18\xb9\x7e\xd6\xcd\xeb\x5d\xca\x22\x80\x01\x80\xfb\xcd\x88\x12\xa3\xa3\x7f\xd3\xe6\x05\x17\xf0\x57\x92\xba\x03\xe6\xd5\x58\xc6\xaf\x69\xdc\xd4\x01\xaa\xfe\x37\xee\x06\x99\x96\x92\x07\x57\xe8\x90\x91\x69\xb3\xa1\x1d\xf6\xc6\x73\xc4\x86\x3e\xa6\x6c\x08\xef\xc0\x57\x8c\x65\x27\xba\xe7\x78\x35\x77\xc1\xe1\x26\xb4\x2e\xb9\xc4\xd7\xae\xbf\x0c\x1f\x94\xfd\x18\xb6\xa2\xe8\x33\x1e\xa6\x8e\x93\xe4\x9c\xce\x3b\xc0\x05\xd8\x64\x99\xa6\xbd\xbd\xe8\x13\xaf\xef\xac\xa0\x45\xff\x12\x50\x9c\x26\x18\xf6\xb9\xeb\xf7\xc4\xcb\xd6\xbf\x29\xda\x9e\x70\x2c\x87\x01\xa6\xec\x3a\x08\x0a\x06\x31\x37\x2e\x30\x2e\x31\x40\x01\x4a\xb0\x01\x00\x00\x00\x02\x00\x00\x00\xb0\x00\x05\x00\x10\x87\xee\x91\xc0\x16\xac\x87\x10\x00\x00\x00\x42\x00\x00\x00\x10\x00\x00\x00\x54\x00\x00\x00\x40\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x9a\x00\x00\x00\x10\x00\x00\x00\xac\x00\x00\x00\x10\x00\x00\x00\xbe\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xd4\x00\x00\x00\x10\x58\xe4\xdc\x0f\xed\xa1\xfb\x18\x89\x5d\xb2\xaa\xa5\x53\x3c\xf2\x15\xdc\x73\x3c\x2c\x3d\xb0\xff\xdf\xe3\x23\xab\x6f\xe6\xd8\xac\x58\x00')
		# license = "CAIS7gEKKgoQCSbrQo77t5qv7Y3a5OTq1xIIy8ybroPfSGEgASgAOABAAEjhvcevBhIQCAEQABgAIAAoAGABcAB4ABpWEhC1KvBWWj6uc2hkVQ9naR3AGkA1QOS5bqZmJnAD60pNy4q69nZTJRkcWqfbdYyocLXhS19DMtj1FMnHyIvug5Y59bxYrTHn3P2raQUGlaQ0pQaRIAEaTAoQnrQFDeRLSAKTLifXUIPiZhIQCNGQ6IXoVwIcmodUcfQrGhoQ9vVmFVeuXOtXBgviSXCrQyACQhIKEGtjMTYAAAAAnDdmkgAAAAgg4b3HrwY4AFACGiCCmdN3PKpMx/W4amklqmHRLKUVSJMddNMTpSiLBlm0yCKAAXAr4vuzuESfEelvZ1/8xgQvr+QrNzeyuOIysf8nK1WVw2bnzqDSpNRV2jZQNNwfuF31C5yGd4ayGzqB0BKvJsa4K/ag7ZloZLEVlUJmODMjkNPQ+PIHq/DA0winIUtp6UQSHZbst5CvmTtJVAeT28FhzwdBj02mMRjtnWBH3ndLOggKBjE3LjAuMUABSrABAAAAAgAAALAABQAQnDdmkgTtiNMAAABCAAAAEAAAAFQAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAACaAAAAEAAAAKwAAAAQAAAAvgAAABAAAAAAAAAAAAAAANQAAAAQyvQX103F9ZlJ174/gWLPhvWGqHhTVKl5dLPPc+b/Hv9YAA=="


	# resp = Response(base64.b64decode(license), mimetype='application/octet-stream')
	resp = Response(license, mimetype='application/octet-stream')
	resp.headers['Date'] =  'Wed, 13 Mar 2024 22:01:04 GMT'
	resp.headers['Content-Type'] = 'application/octet-stream'
	resp.headers['X-AxDRM-Identity'] = 'Axinom DRM - Widevine API'
	resp.headers['X-AxDRM-Version'] = '6.24.1'
	resp.headers['X-AxDRM-Server'] = 'widevine-testing-68f88bb687-57q4v'
	resp.headers['Access-Control-Allow-Origin'] = '*'
	resp.headers['Access-Control-Expose-Headers'] = 'X-AxDrm-ErrorMessage,X-AxDRM-Message,X-AxDRM-Identity,X-AxDRM-Server,X-AxDRM-Version,X-Powered-By,WWW-Authenticate'
	resp.headers['Strict-Transport-Security'] = 'max-age=15724800; includeSubDomains'

	return resp








